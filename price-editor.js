// „É°„É´„Ç´„É™ÂïÜÂìÅÁ∑®ÈõÜ„Éö„Éº„Ç∏„Åß„ÅÆ‰æ°Ê†ºÂ§âÊõ¥Âá¶ÁêÜ
console.log('üîß ‰æ°Ê†ºÁ∑®ÈõÜ„Çπ„ÇØ„É™„Éó„Éà„ÅåË™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„Åü');
console.log('üìç ÁèæÂú®„ÅÆURL:', window.location.href);
console.log('üìÑ „Éö„Éº„Ç∏„Çø„Ç§„Éà„É´:', document.title);

// „Çπ„ÇØ„É™„Éó„Éà„ÅåÊ≠£„Åó„ÅèË™≠„ÅøËæº„Åæ„Çå„Åü„Åì„Å®„ÇíÁ¢∫Ë™ç
if (window.location.href.includes('/sell/edit/')) {
  console.log('‚úÖ Á∑®ÈõÜ„Éö„Éº„Ç∏„Åß„Çπ„ÇØ„É™„Éó„Éà„ÅåÂÆüË°å„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
} else {
  console.warn('‚ö†Ô∏è Á∑®ÈõÜ„Éö„Éº„Ç∏„Åß„ÅØ„Å™„ÅÑ„Éö„Éº„Ç∏„Åß„Çπ„ÇØ„É™„Éó„Éà„ÅåÂÆüË°å„Åï„Çå„Åæ„Åó„Åü');
}

// ‰æ°Ê†ºÊõ¥Êñ∞Èñ¢Êï∞
async function updateProductPrice(productId, newPrice) {
  console.log(`ÂïÜÂìÅID ${productId} „ÅÆ‰æ°Ê†º„Çí ${newPrice}ÂÜÜ „Å´Â§âÊõ¥ÈñãÂßã`);
  
  // „Éá„Éê„ÉÉ„Ç∞: ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏ÊÉÖÂ†±„ÇíÂá∫Âäõ
  console.log('ÁèæÂú®„ÅÆURL:', window.location.href);
  console.log('„Éö„Éº„Ç∏„Çø„Ç§„Éà„É´:', document.title);
  
  // ÂïÜÂìÅË©≥Á¥∞„Éö„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅØÁ∑®ÈõÜ„Éö„Éº„Ç∏„Å´ÁßªÂãï
  if (window.location.href.includes('/item/')) {
    console.log('üîÑ ÂïÜÂìÅË©≥Á¥∞„Éö„Éº„Ç∏„Åã„ÇâÁ∑®ÈõÜ„Éö„Éº„Ç∏„Å´ÁßªÂãï‰∏≠...');
    const editUrl = window.location.href.replace('/item/', '/sell/edit/');
    console.log('Á∑®ÈõÜ„Éö„Éº„Ç∏URL:', editUrl);
    window.location.href = editUrl;
    return { success: false, message: 'Á∑®ÈõÜ„Éö„Éº„Ç∏„Å´ÁßªÂãï‰∏≠...' };
  }
  
  // Á∑®ÈõÜ„Éö„Éº„Ç∏„Åß„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç®„É©„Éº
  if (!window.location.href.includes('/sell/edit/')) {
    throw new Error('Á∑®ÈõÜ„Éö„Éº„Ç∏„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì: ' + window.location.href);
  }
  
  // DOMÂÖ®‰Ωì„Çí„Éá„Éê„ÉÉ„Ç∞
  debugPageStructure();
  
  try {
    // ‰æ°Ê†ºÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÊé¢„Åó„Å¶ÂÄ§„ÇíË®≠ÂÆö
    const priceInput = await waitForElement([
      'input[name="price"]',
      'input[data-testid="price-input"]',
      'input[placeholder*="‰æ°Ê†º"]',
      'input[id*="price"]',
      'input[class*="price"]'
    ], 10000);
    
    if (!priceInput) {
      throw new Error('‰æ°Ê†ºÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
    }
    
    console.log('‰æ°Ê†ºÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÁô∫Ë¶ã:', priceInput);
    console.log(` ‰æ°Ê†ºÂÖ•Âäõ„Éá„Éê„ÉÉ„Ç∞:`);
    console.log(`  - ÂÖÉ„ÅÆ‰æ°Ê†º: ${priceInput.value}`);
    console.log(`  - Êñ∞„Åó„ÅÑ‰æ°Ê†º: ${newPrice} (typeof: ${typeof newPrice})`);
    
    // ÁèæÂú®„ÅÆ‰æ°Ê†º„Çí„ÇØ„É™„Ç¢„Åó„Å¶Êñ∞„Åó„ÅÑ‰æ°Ê†º„ÇíÂÖ•Âäõ
    priceInput.focus();
    priceInput.select();
    priceInput.value = newPrice.toString();
    
    console.log(`  - ÂÖ•ÂäõÂæå„ÅÆÂÄ§: ${priceInput.value}`);
    
    // input„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´„Åó„Å¶ÂÄ§„ÅÆÂ§âÊõ¥„ÇíÈÄöÁü•
    priceInput.dispatchEvent(new Event('input', { bubbles: true }));
    priceInput.dispatchEvent(new Event('change', { bubbles: true }));
    priceInput.dispatchEvent(new Event('blur', { bubbles: true }));
    
    console.log(`‰æ°Ê†º„Çí ${newPrice}ÂÜÜ „Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü (ÁèæÂú®„ÅÆÂÄ§: ${priceInput.value})`);
    
    // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊé¢„Åó„Å¶Êäº„Åô
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊé¢„Åó„Å¶„ÇØ„É™„ÉÉ„ÇØ
    const saveButton = await waitForElement([
      'button:contains("Âá∫ÂìÅ„Åô„Çã")',
      'button:contains("Â§âÊõ¥„Çí‰øùÂ≠ò")',
      'button:contains("‰øùÂ≠ò")',
      'button:contains("Êõ¥Êñ∞")',
      'button[data-testid="save-button"]',
      'button[data-testid="update-button"]',
      'button[data-testid="submit-button"]',
      'button[type="submit"]',
      'form button:last-child',
      'button[class*="save"]',
      'button[class*="Save"]',
      'button[class*="update"]',
      'button[class*="Update"]',
      'button[class*="submit"]',
      'button[class*="Submit"]'
    ], 10000);
    
    if (saveButton) {
      console.log('‰øùÂ≠ò„Éú„Çø„É≥„ÇíÁô∫Ë¶ã:', saveButton);
      
      // „Éú„Çø„É≥„ÅåÊúâÂäπ„ÅãÁ¢∫Ë™ç
      if (saveButton.disabled) {
        console.warn('‚ö†Ô∏è ‰øùÂ≠ò„Éú„Çø„É≥„ÅåÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
        return { success: false, error: '‰øùÂ≠ò„Éú„Çø„É≥„ÅåÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô' };
      }
      
      // „Éï„Ç©„Éº„É†„Çí‰∫ãÂâç„Å´ÂèñÂæó
      const form = priceInput.closest('form');
      console.log('üìÑ „Éï„Ç©„Éº„É†„ÇíÁô∫Ë¶ã:', form);
      
      // „Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ
      console.log('üíæ ‰øùÂ≠ò„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ‰∏≠...');
      
      // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Åß„Éï„Ç©„Éº„É†ÈÄÅ‰ø°„ÇíÁõ£Ë¶ñ
      let formSubmitted = false;
      if (form) {
        const submitHandler = () => {
          console.log('‚úÖ „Éï„Ç©„Éº„É†ÈÄÅ‰ø°„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü');
          formSubmitted = true;
        };
        form.addEventListener('submit', submitHandler, { once: true });
        
        // „Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
        saveButton.click();
        
        // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°„ÇíÂæÖÊ©ü
        await new Promise(resolve => {
          const checkSubmit = () => {
            if (formSubmitted) {
              console.log('üéØ „Éï„Ç©„Éº„É†ÈÄÅ‰ø°ÂÆå‰∫Ü');
              resolve();
            } else {
              setTimeout(checkSubmit, 100);
            }
          };
          checkSubmit();
          // „Çø„Ç§„É†„Ç¢„Ç¶„Éà
          setTimeout(() => {
            if (!formSubmitted) {
              console.log('‚è∞ „Éï„Ç©„Éº„É†ÈÄÅ‰ø°„Çø„Ç§„É†„Ç¢„Ç¶„Éà - ÊâãÂãï„ÅßÈÄÅ‰ø°„ÇíË©¶Ë°å');
              try {
                if (form.isConnected) {
                  form.requestSubmit();
                } else {
                  console.log('‚ö†Ô∏è „Éï„Ç©„Éº„É†„ÅåDOM„Åã„ÇâÂàáÊñ≠„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                }
              } catch (error) {
                console.log('‚ö†Ô∏è ÊâãÂãïÈÄÅ‰ø°„Ç®„É©„Éº:', error.message);
              }
              resolve();
            }
          }, 2000);
        });
      } else {
        // „Éï„Ç©„Éº„É†„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÂçòÁ¥î„Å´„ÇØ„É™„ÉÉ„ÇØ
        saveButton.click();
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      // ‰øùÂ≠òÂæå„ÅÆÁ¢∫Ë™ç„ÇíÂæÖ„Å§
      await new Promise(resolve => setTimeout(resolve, 3000));
      
      console.log('‚úÖ ‰æ°Ê†ºÂ§âÊõ¥Âá¶ÁêÜ„ÇíÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
      return { success: true, message: `‰æ°Ê†º„Çí${newPrice}ÂÜÜ„Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü` };
    } else {
      console.warn('‚ö†Ô∏è ‰øùÂ≠ò„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
      return { success: false, error: '‰øùÂ≠ò„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì' };
    }
    
  } catch (error) {
    console.error('‰æ°Ê†ºÊõ¥Êñ∞„Ç®„É©„Éº:', error);
    return { success: false, error: error.message };
  }
}

// Ë¶ÅÁ¥†„ÇíÂæÖÊ©ü„Åô„ÇãÈñ¢Êï∞
function waitForElement(selectors, timeout = 5000) {
  return new Promise((resolve) => {
    const startTime = Date.now();
    
    function checkElement() {
      for (const selector of selectors) {
        let element;
        
        if (selector.includes(':contains(')) {
          // :contains() „Çª„É¨„ÇØ„Çø„Éº„ÅÆÂá¶ÁêÜ
          const text = selector.match(/:contains\("([^"]+)"\)/)?.[1];
          if (text) {
            const buttons = document.querySelectorAll('button');
            element = Array.from(buttons).find(btn => 
              btn.textContent.includes(text)
            );
          }
        } else {
          element = document.querySelector(selector);
        }
        
        if (element) {
          console.log(`Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü: ${selector}`);
          resolve(element);
          return;
        }
      }
      
      if (Date.now() - startTime < timeout) {
        setTimeout(checkElement, 100);
      } else {
        console.warn('Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü:', selectors);
        resolve(null);
      }
    }
    
    checkElement();
  });
}

// „É°„ÉÉ„Çª„Éº„Ç∏„É™„Çπ„Éä„Éº
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  console.log('üì® „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèó‰ø°:', request);
  
  if (request.action === 'updatePrice') {
    console.log(`üîÑ ‰æ°Ê†ºÊõ¥Êñ∞ÈñãÂßã: ÂïÜÂìÅID ${request.productId} „Çí ${request.newPrice}ÂÜÜ „Å´Â§âÊõ¥`);
    
    updateProductPrice(request.productId, request.newPrice)
      .then((result) => {
        console.log('‚úÖ ‰æ°Ê†ºÊõ¥Êñ∞ÊàêÂäü:', result);
        
        // ÊàêÂäüÊôÇ„ÅØ3ÁßíÂæå„Å´„Çø„Éñ„ÇíÈñâ„Åò„ÇãÔºà„Éá„Éê„ÉÉ„Ç∞„ÅÆ„Åü„ÇÅ‰∏ÄÊôÇÁÑ°ÂäπÂåñÔºâ
        console.log('üîí ‰æ°Ê†ºÊõ¥Êñ∞ÂÆå‰∫Ü - „Çø„Éñ„ÇØ„É≠„Éº„Ç∫„ÅØÁÑ°ÂäπÂåñ‰∏≠Ôºà„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÔºâ');
        // setTimeout(() => {
        //   console.log('üîí ‰æ°Ê†ºÊõ¥Êñ∞ÂÆå‰∫Ü - „Çø„Éñ„ÇíÈñâ„Åò„Åæ„Åô');
        //   chrome.runtime.sendMessage({ action: 'closeTab' });
        // }, 3000);
        
        sendResponse({ success: true, result: result });
      })
      .catch((error) => {
        console.error('‚ùå ‰æ°Ê†ºÊõ¥Êñ∞Â§±Êïó:', error);
        
        // „Ç®„É©„ÉºÊôÇ„ÅØ1ÁßíÂæå„Å´„Çø„Éñ„ÇíÈñâ„Åò„ÇãÔºà„Éá„Éê„ÉÉ„Ç∞„ÅÆ„Åü„ÇÅ‰∏ÄÊôÇÁÑ°ÂäπÂåñÔºâ
        console.log('‚ùå ‰æ°Ê†ºÊõ¥Êñ∞„Ç®„É©„Éº - „Çø„Éñ„ÇØ„É≠„Éº„Ç∫„ÅØÁÑ°ÂäπÂåñ‰∏≠Ôºà„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÔºâ');
        // setTimeout(() => {
        //   console.log('‚ùå ‰æ°Ê†ºÊõ¥Êñ∞„Ç®„É©„Éº - „Çø„Éñ„ÇíÈñâ„Åò„Åæ„Åô');
        //   chrome.runtime.sendMessage({ action: 'closeTab' });
        // }, 1000);
        
        sendResponse({ success: false, error: error.message });
      });
    
    return true; // ÈùûÂêåÊúü„É¨„Çπ„Éù„É≥„Çπ„ÇíÁ§∫„Åô
  }
  
  sendResponse({ success: false, error: 'Unknown action' });
});

// „Éö„Éº„Ç∏ÊßãÈÄ†„Çí„Éá„Éê„ÉÉ„Ç∞„Åô„ÇãÈñ¢Êï∞
function debugPageStructure() {
  console.log('=== „Éö„Éº„Ç∏ÊßãÈÄ†„Éá„Éê„ÉÉ„Ç∞ ===');
  
  // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÊé¢„Åô
  const inputs = document.querySelectorAll('input');
  console.log(`ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÊï∞: ${inputs.length}`);
  inputs.forEach((input, index) => {
    console.log(`Input ${index + 1}:`, {
      type: input.type,
      name: input.name,
      placeholder: input.placeholder,
      'data-testid': input.getAttribute('data-testid'),
      className: input.className,
      value: input.value
    });
  });
  
  // „Éú„Çø„É≥„ÇíÊé¢„Åô
  const buttons = document.querySelectorAll('button');
  console.log(`„Éú„Çø„É≥Êï∞: ${buttons.length}`);
  buttons.forEach((button, index) => {
    console.log(`Button ${index + 1}:`, {
      textContent: button.textContent.trim(),
      type: button.type,
      'data-testid': button.getAttribute('data-testid'),
      className: button.className,
      disabled: button.disabled
    });
  });
  
  console.log('=== „Éá„Éê„ÉÉ„Ç∞ÁµÇ‰∫Ü ===');
}

// DOM„ÅåË™≠„ÅøËæº„Åæ„Çå„Åü„Çâ„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíÂá∫Âäõ
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üìÑ DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
    debugPageStructure();
  });
} else {
  console.log('üìÑ DOM„ÅØÊó¢„Å´Ë™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô');
  setTimeout(debugPageStructure, 1000); // 1ÁßíÂæÖ„Å£„Å¶„Åã„Çâ„Éá„Éê„ÉÉ„Ç∞
}

console.log('üéâ ‰æ°Ê†ºÁ∑®ÈõÜ„Çπ„ÇØ„É™„Éó„Éà„ÅÆÂàùÊúüÂåñÂÆå‰∫Ü');
